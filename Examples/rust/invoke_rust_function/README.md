# Invoke a Rust function from C++ code

## Use case
Some functionality is available in a Rust crate that does not provide a C API or
we want to implement some new functionality using Rust, may be to leverage on
some existing Rust crate.

## Implementation
For Rust (or any other language) we can use C bindings or C++ bindings if the
language supports them. The easiest option is to use
[Corrosion](https://corrosion-rs.github.io/corrosion) and
[cxx](https://cxx.rs/).

In this example we use an algorithm to invoke some Rust code, but the
procedure is applicable to services or tools.

### The Rust library (AKA crate)
Rust code is hosted in a subdirectory created with the standard Rust package
manager [cargo](https://doc.rust-lang.org/cargo/) and we adapt it to be able to
use it from CMake.

We first create the crate directory with `cargo init --lib my_crate`, then we
add the dependency on [cxx](https://cxx.rs/) with
`(cd my_crate && cargo add cxx --features c++20)` (needed to generate C++-Rust bridges).
To tell Rust to produce a library that we can use from C++ we have to edit `my_crate/Cargo.toml`
adding the lines:
```toml
[lib]
crate-type = ["staticlib"]
```
It's possible to use `cdylib` instead of `staticlib`, but it make the deployment
a bit more complicated as we have to instruct CMake to install the shared
library built with Corrosion.

You my also want to add the line
```toml
publish = false
```
in the section `[package]` to prevent accidental publishing on <https://crates.io>.

To define what is shared between the two worlds, please, refer to
[cxx docs](https://cxx.rs/reference.html).

### CMake
[Corrosion](https://corrosion-rs.github.io/corrosion), with some limitations,
simplify enormously the task of running Rust builds from CMake and use the build
library.

Just adding the code
```cmake
corrosion_import_crate(
    MANIFEST_PATH my_crate/Cargo.toml
    LOCKED
)
corrosion_add_cxxbridge(
    my_crate_bridge
    CRATE my_crate
    FILES lib.rs
)
```
is enough to be able to link a C++ library against the target `my_crate_bridge`
and access Rust functions.

If you chose to use `cdylib` instead of `staticlib` you need to install the
headers generated by `corrosion_add_cxxbridge`
(see [Corrosion docs](https://corrosion-rs.github.io/corrosion/usage.html#experimental-install-crate-and-headers-with-corrosion_install)).

### C++
To access Rust code from C++ is enough to link against `my_crate_bridge` and add
```cpp
#include <my_crate_bridge/lib.h>
```
to the source file and access the functions from your code.

Since Rust an C++ do not agree on some idioms, `cxx` provides helper classes to
access Rust idiomatic helpers (like `Box<T>` and `Result<T>`) in C++ and
viceversa (like `std::string` and `std::unique_ptr`). The full list of mappings
is available on [cxx docs](https://cxx.rs/bindings.html).
